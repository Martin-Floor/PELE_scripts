import mdtraj as md
import nglview as nv

def loadTrajectoryFrames(report_data, trajectory_files, topology_file):
    """
    Load only trajectory frames contained in the report_data object (see readReportFiles()
    function at pele_read on how is generated).

    Parameters
    ==========
    report_data : pandas.DataFrame
        Data frame containing PELE output data. Is generated by pele_read.readReportFiles()
        function.
    trajectory_files : dict
        Contains path to PELE output trajectory files. Is generated by pele_read.getTrajectoryFiles()
        function.
    topology_file : str
        Path to the PDB topology file. Can be obtained with pele_read.getTopologyFile()
        function.

    Returns
    =======
    trajectory : mdtraj.core.trajectory.Trajectory
        Trajectory containing all frames contained in the report_data object.
    """
    e_values = report_data.index.get_level_values('Epoch')
    t_values = report_data.index.get_level_values('Trajectory')
    p_steps = report_data.index.get_level_values('Pele Step')

    values = list(zip(e_values, t_values, p_steps))
    trajs = []
    for v in values:
        trajs.append(md.load_frame(trajectory_files[v[0]][v[1]], v[2], top=topology_file))
    trajectory = md.join(trajs)

    return trajectory

def showTrajectory(trajectory, residues=[]):
    """
    Show PELE trajectory center on ligand. It takes an optional list of residues to depict.

    Parameters
    ==========
    trajectory : mdtraj.core.trajectory.Trajectory
        PELE trajectory to depict
    residues : list
        List of residue indexes to depict.
    """

    show = nv.show_mdtraj(trajectory)
    show.clear_representations()
    show.add_representation('licorice', selection='ligand')
    for r in residues:
        show.add_representation('licorice', selection=str(r))
    show.add_representation('cartoon', selection='protein', color='w')
    show.center(selection='ligand')

    return show

def addMetricFromFunction(metric_function, report_data, trajectory_files, topology_file, labels=[]):

    e_values = report_data.index.get_level_values('Epoch')
    t_values = report_data.index.get_level_values('Trajectory')

    metrics = []
    for v in zip(e_values, t_values):
        traj = md.load(trajectory_files[v[0]][v[1]], top=topology_file)
        metrics.append(metric_function(traj))
        break

    metrics = np.hstack(metrics)

    return metrics
